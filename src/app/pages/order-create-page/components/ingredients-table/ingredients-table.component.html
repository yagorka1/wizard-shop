<div class="flex items-center justify-center min-h-screen p-4">
  <p-card class="mb-0 w-full max-w-[1200px] rounded-xl relative">
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full p-6">
      <span class="text-xl font-semibold">
       Выберите ингредиенты
      </span>

        <p-button
          severity="secondary"
          label="Назад"
          (onClick)="goBack()"
          styleClass="mb-4"
        />
      </div>
    </ng-template>

    <ng-container [formGroup]="form">
      <p-table [value]="ingredientsControls" [tableStyle]="{'min-width': '60rem'}" class="h-[50vh] overflow-y-auto">
        <ng-template pTemplate="header">
          <tr>
            <th style="width:5%">Выбрать</th>
            <th style="width:20%">Название</th>
            <th style="width:12%">Редкость</th>
            <th style="width:25%">Эффект</th>
            <th style="width:12%">Цена за 100г</th>
            <th style="width:15%">Процент</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-group let-ri="rowIndex">
          <tr [formGroup]="group" [class.bg-green-50]="group.get('selected')?.value">
            <td class="align-middle">
              <p-checkbox
                formControlName="selected"
                [binary]="true"
                (onChange)="onSelectionChange(ri)"
              />
            </td>

            <td class="align-middle font-medium">
              {{ group.get('name')?.value }}
            </td>

            <td class="align-middle">
              <span 
                class="px-2 py-1 rounded text-xs font-medium"
                [ngClass]="{
                  'bg-gray-200 text-gray-700': group.get('rarity')?.value === 'обычный',
                  'bg-green-200 text-green-700': group.get('rarity')?.value === 'необычный',
                  'bg-blue-200 text-blue-700': group.get('rarity')?.value === 'редкий',
                  'bg-purple-200 text-purple-700': group.get('rarity')?.value === 'очень редкий',
                  'bg-orange-200 text-orange-700': group.get('rarity')?.value === 'легендарный'
                }"
              >
                {{ group.get('rarity')?.value }}
              </span>
            </td>

            <td class="align-middle text-sm text-gray-600">
              {{ group.get('effect')?.value }}
            </td>

            <td class="align-middle">
              {{ group.get('price')?.value | number:'1.2-2' }} РУБ
            </td>

            <td class="align-middle">
              <div class="input-wrapper" style="min-height: 32px;">
                @if (group.get('selected')?.value) {
                  <app-input formControlName="percent" placeholder="%" type="number"></app-input>
                } @else {
                  <div class="h-8 flex items-center">
                    <span class="text-gray-400">—</span>
                  </div>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </ng-container>

    <div class="mt-6 p-4 bg-gray-100 rounded-lg">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <span class="font-medium">Выбрано ингредиентов: {{ selectedIngredients.length }}</span>
        <span class="font-medium" [class.text-green-600]="totalPercent === 100" [class.text-red-600]="totalPercent !== 100">
          Общий процент: {{ totalPercent }}%
        </span>
        <span class="font-medium text-blue-600">
          Итого: {{ totalPrice | number:'1.2-2' }} РУБ
        </span>
      </div>
    </div>

    @if (tableErrors.length > 0) {
      <div class="mt-4 p-4 bg-red-100 rounded-lg text-red-700">
        <ul class="list-disc pl-5">
          @for (error of tableErrors; track error) {
            <li>{{ error }}</li>
          }
        </ul>
      </div>
    }

    @if (canSaveOrder) {
      <p-button
        severity="success"
        class="block mt-6"
        label="Сделать заказ"
        [disabled]="isDisableButton"
        icon="pi pi-check"
        (onClick)="save()"
      />
    }
  </p-card>
</div>
